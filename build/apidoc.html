<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/tonyskn/node-redis-timeseries"

    >redis-timeseries (v0.4.0)</a>
</h1>
<h4>Manage timeseries data storage in Redis with ease</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.redis-timeseries">module redis-timeseries</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.redis-timeseries">
            function <span class="apidocSignatureSpan"></span>redis-timeseries
            <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries">
            function <span class="apidocSignatureSpan">redis-timeseries.</span>timeseries
            <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">redis-timeseries.</span>timeseries.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.redis-timeseries.timeseries">module redis-timeseries.timeseries</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.timeseries">
            function <span class="apidocSignatureSpan">redis-timeseries.</span>timeseries
            <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.redis-timeseries.timeseries.prototype">module redis-timeseries.timeseries.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.days">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>days
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.exec">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>exec
            <span class="apidocSignatureSpan">(callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.getHits">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>getHits
            <span class="apidocSignatureSpan">(key, gran, count, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.hours">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>hours
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.minutes">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>minutes
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.months">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>months
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.recordHit">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>recordHit
            <span class="apidocSignatureSpan">(key, timestamp, increment)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.removeHit">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>removeHit
            <span class="apidocSignatureSpan">(key, timestamp, decrement)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.seconds">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>seconds
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.redis-timeseries.timeseries.prototype.weeks">
            function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>weeks
            <span class="apidocSignatureSpan">(i)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.redis-timeseries" id="apidoc.module.redis-timeseries">module redis-timeseries</a></h1>


    <h2>
        <a href="#apidoc.element.redis-timeseries.redis-timeseries" id="apidoc.element.redis-timeseries.redis-timeseries">
        function <span class="apidocSignatureSpan"></span>redis-timeseries
        <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">redis-timeseries = function (redis, keyBase, granularities) {
  this.redis = redis;
  this.keyBase = keyBase || &#x27;stats&#x27;;
  this.pendingMulti = redis.multi();
  this.granularities = granularities || {
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries" id="apidoc.element.redis-timeseries.timeseries">
        function <span class="apidocSignatureSpan">redis-timeseries.</span>timeseries
        <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">timeseries = function (redis, keyBase, granularities) {
  this.redis = redis;
  this.keyBase = keyBase || &#x27;stats&#x27;;
  this.pendingMulti = redis.multi();
  this.granularities = granularities || {
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.redis-timeseries.timeseries" id="apidoc.module.redis-timeseries.timeseries">module redis-timeseries.timeseries</a></h1>


    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.timeseries" id="apidoc.element.redis-timeseries.timeseries.timeseries">
        function <span class="apidocSignatureSpan">redis-timeseries.</span>timeseries
        <span class="apidocSignatureSpan">(redis, keyBase, granularities)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">timeseries = function (redis, keyBase, granularities) {
  this.redis = redis;
  this.keyBase = keyBase || &#x27;stats&#x27;;
  this.pendingMulti = redis.multi();
  this.granularities = granularities || {
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.redis-timeseries.timeseries.prototype" id="apidoc.module.redis-timeseries.timeseries.prototype">module redis-timeseries.timeseries.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.days" id="apidoc.element.redis-timeseries.timeseries.prototype.days">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>days
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">days = function (i) { return i*this.hours(24); }</pre></li>
    <li>example usage<pre class="apidocCodePre">...

The default granularities are:

```javascript
{
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.<span class="apidocCodeKeywordSpan">days</span>(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
}
```

This means that the number of `hits per second` will be stored for `5 minutes`, and the corresponding hashset will expire afterwards
.  Likewise, the number of `hits per minute` for a given key will be kept for an `hour`.  `Daily` counters on the other hand are
 kept for a full year.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.exec" id="apidoc.element.redis-timeseries.timeseries.prototype.exec">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>exec
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">exec = function (callback) {
  // Reset pendingMulti before proceeding to
  // avoid concurrent modifications
  var current = this.pendingMulti;
  this.pendingMulti = this.redis.multi();

  current.exec(callback);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	// &#x22;timestamp&#x22; defaults to the current time
// &#x22;increment&#x22; defaults to 1
	//
	ts.recordHit(&#x27;your_stats_key&#x27;)
	  .recordHit(&#x27;another_stats_key&#x27;, timestamp)
  .recordHit(&#x27;another_stats_key&#x27;, timestamp2, increment)
	  …
	  .<span class="apidocCodeKeywordSpan">exec</span>();

// Removing hits
//
// It&#x27;s also possible to decrement the hits counter for
// some key
ts.removeHit(&#x27;your_stats_key&#x27;, [timestamp]).exec();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.getHits" id="apidoc.element.redis-timeseries.timeseries.prototype.getHits">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>getHits
        <span class="apidocSignatureSpan">(key, gran, count, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getHits = function (key, gran, count, callback) {
  var properties = this.granularities[gran],
      currentTime = getCurrentTime();

  if (typeof properties === &#x22;undefined&#x22;) {
    return callback(new Error(&#x22;Unsupported granularity: &#x22;+gran));
  }

  if (count &#x3e; properties.ttl / properties.duration) {
    return callback(new Error(&#x22;Count: &#x22;+count+&#x22; exceeds the maximum stored slots for granularity: &#x22;+gran));
  }

  var from = getRoundedTime(properties.duration, currentTime - count*properties.duration),
      to = getRoundedTime(properties.duration, currentTime);

  for(var ts=from, multi=this.redis.multi(); ts&#x3c;=to; ts+=properties.duration) {
    var keyTimestamp = getRoundedTime(properties.ttl, ts),
        tmpKey = [this.keyBase, key, gran, keyTimestamp].join(&#x27;:&#x27;);

    multi.hget(tmpKey, ts);
  }

  multi.exec(function(err, results) {
    if (err) {
      return callback(err);
    }

    for(var ts=from, i=0, data=[]; ts&#x3c;=to; ts+=properties.duration, i+=1) {
      data.push([ts, results[i] ? parseInt(results[i], 10) : 0]);
    }

    return callback(null, data.slice(Math.max(data.length - count, 0)));
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    ts.removeHit(&#x27;your_stats_key&#x27;, [timestamp]).exec();
	
	// Querying statistics
	//
	// Returns &#x22;count&#x22; chunks of counters at the precision described by
	// &#x22;granularity_label&#x22;
	//
	ts.<span class="apidocCodeKeywordSpan">getHits</span>(&#x27;your_stats_key&#x27;, granularity_label, count, function(err, data) {
		// data.length == count
		// data = [ [ts1, count1], [ts2, count2]... ]
	});
```

## Defining custom statistics granularities
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.hours" id="apidoc.element.redis-timeseries.timeseries.prototype.hours">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>hours
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hours = function (i) { return i*this.minutes(60); }</pre></li>
    <li>example usage<pre class="apidocCodePre">...
For each key, `TimeSeries` stores statistics at different granularities. For further information about this, please refer to the
 detailed [blog post](http://blog.apiaxle.com/post/storing-near-realtime-stats-in-redis/) from the ApiAxle project.

The default granularities are:

```javascript
{
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.<span class="apidocCodeKeywordSpan">hours</span>(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
}
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.minutes" id="apidoc.element.redis-timeseries.timeseries.prototype.minutes">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>minutes
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">minutes = function (i) { return i*60; }</pre></li>
    <li>example usage<pre class="apidocCodePre">...

For each key, `TimeSeries` stores statistics at different granularities. For further information about this, please refer to the
 detailed [blog post](http://blog.apiaxle.com/post/storing-near-realtime-stats-in-redis/) from the ApiAxle project.

The default granularities are:

```javascript
{
    &#x27;1second&#x27;  : { ttl: this.<span class="apidocCodeKeywordSpan">minutes</span>(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.weeks(52) , duration: this.days(1) }
}
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.months" id="apidoc.element.redis-timeseries.timeseries.prototype.months">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>months
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">months = function (i) { return i*(this.weeks(4)+this.days(2)); }</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.recordHit" id="apidoc.element.redis-timeseries.timeseries.prototype.recordHit">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>recordHit
        <span class="apidocSignatureSpan">(key, timestamp, increment)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">recordHit = function (key, timestamp, increment) {
  var self = this;

  Object.keys(this.granularities).forEach(function(gran) {
    var properties = self.granularities[gran],
        keyTimestamp = getRoundedTime(properties.ttl, timestamp),
        tmpKey = [self.keyBase, key, gran, keyTimestamp].join(&#x27;:&#x27;),
        hitTimestamp = getRoundedTime(properties.duration, timestamp);

   self.pendingMulti.hincrby(tmpKey, hitTimestamp, Math.floor(increment || 1));
   self.pendingMulti.expireat(tmpKey, keyTimestamp + 2 * properties.ttl);
  });

  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	//
	// This increments the counters for the
	// stats keys you provide
	//
	// &#x22;timestamp&#x22; defaults to the current time
// &#x22;increment&#x22; defaults to 1
	//
	ts.<span class="apidocCodeKeywordSpan">recordHit</span>(&#x27;your_stats_key&#x27;)
	  .recordHit(&#x27;another_stats_key&#x27;, timestamp)
  .recordHit(&#x27;another_stats_key&#x27;, timestamp2, increment)
	  …
	  .exec();

// Removing hits
//
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.removeHit" id="apidoc.element.redis-timeseries.timeseries.prototype.removeHit">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>removeHit
        <span class="apidocSignatureSpan">(key, timestamp, decrement)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">removeHit = function (key, timestamp, decrement) {
  return this.recordHit(key, timestamp, -(decrement || 1));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	  …
	  .exec();

    // Removing hits
    //
    // It&#x27;s also possible to decrement the hits counter for
    // some key
    ts.<span class="apidocCodeKeywordSpan">removeHit</span>(&#x27;your_stats_key&#x27;, [timestamp]).exec();
	
	// Querying statistics
	//
	// Returns &#x22;count&#x22; chunks of counters at the precision described by
	// &#x22;granularity_label&#x22;
	//
	ts.getHits(&#x27;your_stats_key&#x27;, granularity_label, count, function(err, data) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.seconds" id="apidoc.element.redis-timeseries.timeseries.prototype.seconds">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>seconds
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">seconds = function (i) { return i; }</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.redis-timeseries.timeseries.prototype.weeks" id="apidoc.element.redis-timeseries.timeseries.prototype.weeks">
        function <span class="apidocSignatureSpan">redis-timeseries.timeseries.prototype.</span>weeks
        <span class="apidocSignatureSpan">(i)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">weeks = function (i) { return i*this.days(7); }</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```javascript
{
    &#x27;1second&#x27;  : { ttl: this.minutes(5), duration: 1 },
    &#x27;1minute&#x27;  : { ttl: this.hours(1)  , duration: this.minutes(1) },
    &#x27;5minutes&#x27; : { ttl: this.days(1)   , duration: this.minutes(5) },
    &#x27;10minutes&#x27;: { ttl: this.days(1)   , duration: this.minutes(10) },
    &#x27;1hour&#x27;    : { ttl: this.days(7)   , duration: this.hours(1) },
    &#x27;1day&#x27;     : { ttl: this.<span class="apidocCodeKeywordSpan">weeks</span>(52) , duration: this.days(1) }
}
```

This means that the number of `hits per second` will be stored for `5 minutes`, and the corresponding hashset will expire afterwards
.  Likewise, the number of `hits per minute` for a given key will be kept for an `hour`.  `Daily` counters on the other hand are
 kept for a full year.

When querying for statistics, a granularity label is expected:
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
